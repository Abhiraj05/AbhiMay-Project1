{% extends "base.html" %}
{% block start %}
<div id="loader" class="fixed inset-0 flex items-center justify-center bg-white z-[9999] hidden">
  <div class="flex flex-col items-center space-y-3">
    <div class="w-14 h-14 border-4 border-red-500 border-t-transparent rounded-full animate-spin"></div>
    <p class="text-gray-600 font-medium">Loading...</p>
  </div>
</div>

<div class="min-h-screen flex items-center justify-center px-4">
  <div class="relative w-full max-w-md bg-white rounded-xl p-8 shadow-sm border border-gray-200">
    <div class="flex flex-col items-center mb-6">
      <h2 class="text-2xl font-bold text-gray-800">Reset Password</h2>
      <p class="text-sm text-gray-500 mt-1 text-center">Set a new password for your account</p>
    </div>

    {% if messages %}
      {% for message in messages %}
        <div class="mb-4 px-4 py-3 rounded-lg capitalize {% if message.tags == 'error' %}bg-red-100 border border-red-300 text-red-800{% elif message.tags == 'success' %}bg-green-100 border border-green-300 text-green-800{% endif %} text-sm" role="alert">
          {{ message }}
        </div>
      {% endfor %}
    {% endif %}

    <form method="POST" class="space-y-5" id="resetForm">
      {% csrf_token %}
      <input type="hidden" name="uid" value="{{ request.GET.uid }}">
      <input type="hidden" name="token" value="{{ request.GET.token }}">

      <div>
        <label for="password" class="text-sm font-medium text-gray-700">New Password</label>
        <input type="password" id="password" name="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required
          class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-red-500 focus:ring-1 focus:ring-red-500" />
      </div>

      <div>
        <label for="confirm_password" class="text-sm font-medium text-gray-700">Confirm Password</label>
        <input type="password" id="confirm_password" name="confirm_password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required
          class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-red-500 focus:ring-1 focus:ring-red-500" />
      </div>

      <!-- ðŸ”¹ Button with spinner -->
      <button type="submit" id="submitBtn"
        class="w-full py-2 px-4 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition flex justify-center items-center">
        <span id="btnText">Reset Password</span>
        <svg id="btnLoader" class="hidden ml-2 w-5 h-5 text-white animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4l3-3-3-3v4a8 8 0 100 16v-4l-3 3 3 3v-4a8 8 0 01-8-8z"></path>
        </svg>
      </button>
    </form>

    <p class="text-center text-sm text-gray-600 mt-6">
      Remembered your password? 
      <a href="/login" class="text-red-600 font-semibold hover:underline">Sign in</a>
    </p>
  </div>

  <script>
    // ðŸ”¹ Button loader logic
    document.addEventListener("DOMContentLoaded", function() {
      const form = document.getElementById("resetForm");
      const btn = document.getElementById("submitBtn");
      const btnText = document.getElementById("btnText");
      const btnLoader = document.getElementById("btnLoader");

      form.addEventListener("submit", function() {
        btn.disabled = true;
        btn.classList.add("opacity-75", "cursor-not-allowed");
        btnText.textContent = "Resetting...";
        btnLoader.classList.remove("hidden");
      });
    });

    // ðŸ”¹ Existing page loader (unchanged)
    document.addEventListener("DOMContentLoaded", function() {
      const loader = document.getElementById("loader");

      function showLoaderAndNavigate(target) {
        loader.classList.remove("hidden");
        loader.style.opacity = "1";
        sessionStorage.setItem("navigating", "true");
        setTimeout(() => {
          window.location = target.getAttribute("href");
        }, 1000);
      }

      const internalLinks = document.querySelectorAll(
        'a[href="/forgot_password"], a[href="/login"], a[href="/form"]'
      );

      internalLinks.forEach((link) => {
        link.addEventListener("click", function(e) {
          e.preventDefault();
          showLoaderAndNavigate(this);
        });
      });
    });

    // Hide loader when page loads
    window.addEventListener("load", function() {
      const loader = document.getElementById("loader");
      if (loader) {
        loader.style.opacity = "0";
        loader.style.transition = "opacity 0.5s ease";
        setTimeout(() => loader.classList.add("hidden"), 500);
      }
      sessionStorage.removeItem("navigating");
    });

    // Prevent infinite spinner when coming from back button
    window.addEventListener("pageshow", function(event) {
      const loader = document.getElementById("loader");
      if (event.persisted || sessionStorage.getItem("navigating") !== "true") {
        if (loader) loader.classList.add("hidden");
      }
    });
  </script>
</div>
{% endblock %}
